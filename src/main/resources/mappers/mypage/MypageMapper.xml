<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="MypageMapper">
	<resultMap type="com.bitcamp.sc.domain.mypage.domain.OrderList" id="OrderListDomain">
		<result property="pidx" column="pidx"/>
		<result property="pprice" column="price"/>
		<result property="pdate" column="date"/>
		<result property="pstatus" column="status"/>
		<result property="oidx" column="oidx"/>
		<result property="amount" column="amount"/>
		<result property="gtitle" column="title"/>
		<result property="gname" column="name"/>
		<result property="gphoto" column="photo"/>
	</resultMap>
	
	<resultMap type="com.bitcamp.sc.domain.mypage.domain.RezList" id="RezListDomain">
		<result property="pidx" column="pidx"/>
		<result property="pprice" column="price"/>
		<result property="pway" column="way"/>
		<result property="tpeople" column="people"/>
		<result property="tdate" column="tdate"/>
	</resultMap>
	
	<resultMap type="com.bitcamp.sc.web.mypage.dto.EditMemberRequestDto" id="UpdateMemberDomain">
		<result property="midx" column="id"/>
		<result property="email" column="email"/>
		<result property="name" column="name"/>
		<result property="newPw" column="pw"/>
		<result property="phone" column="phone"/>
		<result property="postcode" column="postcode"/>
		<result property="address1" column="address1"/>
		<result property="address2" column="address2"/>
	</resultMap>

	<!-- 주문 내역 조회 -->
	<select id="getOrderList" resultType="com.bitcamp.sc.domain.mypage.domain.OrderList" resultMap="OrderListDomain">
		SELECT p.id, p.price, date_format(p.date,'%Y-%m-%d') as pdate, p.status, o.id, g.tittle, g.name, g.photo, o.status, o.amount
		FROM payment p, orders o, goods g
		WHERE p.oidx=o.id AND o.gidx =g.id AND o.midx=#{idx} ORDER BY p.date desc;
	</select>
	
	<!-- 예약 내역 조회 -->
	<select id="getRezList" resultType="com.bitcamp.sc.domain.mypage.domain.RezList" resultMap="RezListDomain">
		SELECT p.id, p.price, p.pway, o.people, t.date FROM payment p, orders o, tour t
		WHERE p.oidx=o.id AND o.tidx=t.id AND o.status='confirmed' AND o.midx=#{idx} ORDER BY t.date;
	</select>

	<!-- 회원 정보 조회 -->
	<select id="getMemberInfo" resultMap="UpdateMemberDomain" parameterType="long">
		SELECT m.id,m.email, m.name, m.phone, a.postcode, a.address1, a.address2
		FROM member m, address a
		WHERE m.id=a.midx AND m.id=#{idx};
	</select>

	<!-- 회원 정보 수정 -->
	<update id="updateMember" parameterType="com.bitcamp.sc.web.mypage.dto.EditMemberRequestDto">
		UPDATE member m, address a
        SET m.name=#{name}, m.pw=#{newPw}, m.phone=#{phone}, a.postcode=#{postcode}, a.address1=#{address1}, a.address2=#{address2}
        WHERE m.id=a.midx AND m.id=#{midx};
	</update>


</mapper>